<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>❤️ Our Movie Date</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #000; --bg-sec: #1a1a1a; --accent: #d81b60; --text: #e0e0e0; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; 
            display: flex; flex-direction: column; 
            height: 100vh; height: 100dvh; 
            overflow: hidden; 
        }

        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .start-box { 
            text-align: center; width: 85%; max-width: 320px; 
            background: #111; padding: 30px; border-radius: 12px; border: 1px solid #333;
        }
        .input-room {
            width: 100%; padding: 12px; margin: 15px 0; border-radius: 6px; 
            border: 1px solid #444; background: #222; color: white; text-align: center; font-size: 16px;
        }
        .big-btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px; 
            font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;
        }
        .btn-host { background: var(--accent); color: white; }
        .btn-guest { background: #333; color: white; border: 1px solid #555; }

        header { 
            height: 40px; background: var(--bg-sec); border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
            flex-shrink: 0;
        }
        .status-pill { font-size: 11px; padding: 4px 8px; background: #333; border-radius: 4px; }
        .status-pill.green { background: #00c853; color: #000; font-weight: bold; }
        .btn-exit { background: #333; color: #aaa; border: 1px solid #444; margin-left: 10px; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 12px; }

        #app-ui { display: none; flex-direction: column; height: 100%; width: 100%; }

        .video-container {
            position: relative; width: 100%; height: 40%; background: #000;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            border-bottom: 1px solid #333;
        }
        /* Both players occupy the same space, we toggle visibility */
        video, #yt-player-container { width: 100%; height: 100%; object-fit: contain; position: absolute; top:0; left:0; }
        #yt-player-container { display: none; } /* Hidden by default */
        iframe { width: 100%; height: 100%; border: none; }

        .controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 10; }
        .c-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #555; color: white;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .c-btn.wide { width: auto; padding: 0 15px; border-radius: 20px; font-size: 12px; }
        .c-btn.mic-on { background: var(--accent); border-color: var(--accent); } 
        .c-btn.mic-off { background: #ff4444; border-color: red; opacity: 1; }

        .chat-container {
            flex-grow: 1; display: flex; flex-direction: column; 
            background: var(--bg-sec); min-height: 0; 
            overflow: hidden; 
        }
        .chat-history {
            flex-grow: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
        }
        .msg { padding: 8px 12px; border-radius: 8px; font-size: 14px; max-width: 85%; }
        .msg.sys { align-self: center; color: #777; font-size: 12px; padding: 0; }
        .msg.me { align-self: flex-end; background: var(--accent); color: white; }
        .msg.her { align-self: flex-start; background: #333; color: #eee; }

        .chat-input-area {
            padding: 10px; background: #000; display: flex; gap: 10px;
            border-top: 1px solid #333;
            flex-shrink: 0; 
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .chat-input {
            flex-grow: 1; padding: 10px 15px; border-radius: 20px;
            border: 1px solid #444; background: #222; color: white;
        }
        .send-btn { 
            width: 40px; height: 40px; border-radius: 50%; 
            background: var(--accent);
            border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        #restore-popup { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(20,20,20,0.95); padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #444; z-index: 50; }
        
        /* YouTube Input Popup */
        #yt-popup {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #111; padding: 20px; border: 1px solid #444; border-radius: 10px; z-index: 100;
            width: 80%; max-width: 300px; text-align: center;
        }
        #yt-input { width: 100%; padding: 8px; margin-bottom: 10px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="start-box">
            <h2 style="color:var(--accent); margin-top:0;">❤️ Our Movie Date</h2>
            <p style="color:#888; font-size:13px;">Enter Room Name:</p>
            <input type="text" id="room-id" class="input-room" placeholder="e.g. love123">
            <button class="big-btn btn-host" onclick="enterApp('host')">Create Room</button>
            <button class="big-btn btn-guest" onclick="enterApp('guest')">Join Room</button>
        </div>
    </div>

    <div id="app-ui">
        <header>
            <div style="font-weight:bold; color:var(--accent);">❤️ Our Movie Date</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div class="status-pill" id="user-count">1 / 2</div>
                <div class="status-pill" id="status">Disconnected</div>
                <button class="btn-exit" onclick="fullExit()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div class="video-container">
            <video id="vid" controls playsinline></video>
            
            <div id="yt-player-container"><div id="yt-player"></div></div>

            <div class="controls">
                <label class="c-btn wide" title="Local File"><i class="fas fa-folder-open"></i><input type="file" id="fileInput" style="display:none" accept="video/*"></label>
                <div class="c-btn wide" onclick="showYTPopup()" title="YouTube Link"><i class="fab fa-youtube"></i></div>
                <div class="c-btn mic-on" id="muteBtn" onclick="toggleHardMute()"><i class="fas fa-microphone"></i></div>
            </div>

            <div id="restore-popup">
                <p style="margin:0 0 15px 0;">Resume from <b id="time-display">00:00</b>?</p>
                <button class="status-pill green" onclick="restoreTime()" style="border:none; cursor:pointer; font-size:14px; padding:8px 16px;">Yes</button>
                <button class="status-pill" onclick="closePopup()" style="border:none; cursor:pointer; font-size:14px; padding:8px 16px; margin-left:10px;">No</button>
            </div>

            <div id="yt-popup">
                <h4 style="margin-top:0;">Paste YouTube Link</h4>
                <input type="text" id="yt-input" placeholder="https://youtu.be/..." onkeypress="if(event.key==='Enter') loadYTFromInput()">
                <button class="status-pill green" onclick="loadYTFromInput()" style="border:none; cursor:pointer; padding:8px 15px;">Load</button>
                <button class="status-pill" onclick="document.getElementById('yt-popup').style.display='none'" style="border:none; cursor:pointer; padding:8px 15px; margin-left:10px;">Cancel</button>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-history" id="chat"></div>
            <div class="chat-input-area">
                <input type="text" id="msgInput" class="chat-input" placeholder="Type..." onkeypress="if(event.key==='Enter') send()">
                <button class="send-btn" onclick="send()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    <audio id="remoteAudio" autoplay></audio>

<script>
    let peer, conn, localStream, currentCall;
    let heartbeatInterval, heartbeatTimer;
    let remoteLock = false; 
    let lockTimer;
    let currentMode = 'local';
    const vid = document.getElementById('vid');
    const ytContainer = document.getElementById('yt-player-container');
    let ytPlayer;
    let ytReady = false;

    if(!window.YT) {
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('yt-player', {
            height: '100%', width: '100%',
            playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
            events: {
                'onReady': () => { ytReady = true; },
                'onStateChange': onYTStateChange
            }
        });
    }

    const savedRoom = localStorage.getItem('activeRoom');
    const savedRole = localStorage.getItem('activeRole');
    if(savedRoom) document.getElementById('room-id').value = savedRoom;

    if (savedRoom && savedRole) {
        enterApp(savedRole, true);
    }

    function enterApp(role) {
        const room = document.getElementById('room-id').value.trim().toLowerCase();
        if(!room) return alert("Enter room name");
        
        localStorage.setItem('activeRoom', room);
        localStorage.setItem('activeRole', role);

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('app-ui').style.display = 'flex';

        peer = new Peer(role === 'host' ? room : null, { debug: 1 });
        
        peer.on('open', (id) => {
            sysMsg(role === 'host' ? `Room Active (${room})` : "Connected");
            if(role === 'guest') connect(room);
        });

        peer.on('error', (err) => {
            if(err.type === 'unavailable-id') { 
                alert("Room is taken. Try a different name.");
                fullExit();
            } else {
                sysMsg("Error: " + err.type);
            }
        });

        peer.on('connection', (c) => handleConn(c));
        peer.on('call', (call) => {
            currentCall = call;
            navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                localStream = stream;
                call.answer(stream);
                call.on('stream', rs => playAudio(rs));
                setMuteUI(true);
            }).catch(e => { 
                call.answer(); 
                call.on('stream', rs => playAudio(rs));
            });
        });
    }

    function connect(hostId) {
        sysMsg("Joining Room...");
        const c = peer.connect(hostId);
        handleConn(c);
        setTimeout(() => {
            navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                localStream = stream;
                const call = peer.call(hostId, stream);
                currentCall = call; 
                call.on('stream', rs => playAudio(rs));
                setMuteUI(true);
            }).catch(e => {});
        }, 1000);
    }

    function handleConn(c) {
        conn = c; setStatus(true); startHeartbeat();
        if(conn.open) {
            conn.send({type:'chat', msg:'Connected ❤️'});
            sysMsg('Connected ❤️');
        } else {
            conn.on('open', () => {
                conn.send({type:'chat', msg:'Connected ❤️'});
                sysMsg('Connected ❤️');
            });
        }
        
        conn.on('data', (d) => {
            if(d.type === 'heartbeat') { resetHeartbeat(); return; }
            if(d.type === 'chat') {
                addMsg('her', d.msg);
                return;
            }
            remoteLock = true;
            clearTimeout(lockTimer);
            lockTimer = setTimeout(() => { remoteLock = false; }, 600);

            if(d.type.startsWith('yt_')) {
                if(currentMode !== 'youtube') switchMode('youtube');
                
                if(d.type === 'yt_load') {
                    sysMsg("Host loaded Video");
                    ytPlayer.loadVideoById(d.id);
                }
                if(d.type === 'yt_play') {
                    let diff = Math.abs(ytPlayer.getCurrentTime() - d.time);
                    if(diff > 1.0) ytPlayer.seekTo(d.time);
                    ytPlayer.playVideo();
                }
                if(d.type === 'yt_pause') {
                    ytPlayer.seekTo(d.time);
                    ytPlayer.pauseVideo();
                }
            } else {
                if(currentMode !== 'local') switchMode('local');
                if(d.type === 'play') { vid.currentTime=d.time; vid.play(); }
                if(d.type === 'pause') { vid.pause(); vid.currentTime=d.time; }
                if(d.type === 'seek') { vid.currentTime=d.time; }
            }
        });
        conn.on('close', () => setStatus(false));
    }


    function switchMode(mode) {
        currentMode = mode;
        if(mode === 'youtube') {
            vid.style.display = 'none'; vid.pause();
            ytContainer.style.display = 'block';
        } else {
            ytContainer.style.display = 'none';
            if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
            vid.style.display = 'block';
        }
    }

    vid.onplay = () => { if(!remoteLock && conn?.open) conn.send({type:'play', time: vid.currentTime}); };
    vid.onpause = () => { if(!remoteLock && conn?.open) conn.send({type:'pause', time: vid.currentTime}); };
    vid.onseeked = () => { if(!remoteLock && conn?.open) conn.send({type:'seek', time: vid.currentTime}); };

    function onYTStateChange(event) {
        if(remoteLock) return;
        if(!conn || !conn.open) return;
        const t = ytPlayer.getCurrentTime();
        if(event.data === YT.PlayerState.PLAYING) {
            conn.send({type:'yt_play', time: t});
        }
        else if(event.data === YT.PlayerState.PAUSED) {
            conn.send({type:'yt_pause', time: t});
        }
    }

    document.getElementById('fileInput').onchange = (e) => {
        const f = e.target.files[0]; if(!f) return;
        switchMode('local');
        vid.src = URL.createObjectURL(f); sysMsg("Loaded: " + f.name);
        
        const t = localStorage.getItem('lastTime');
        if(t && parseFloat(t) > 10) {
            const m = Math.floor(t/60), s = Math.floor(t%60);
            document.getElementById('time-display').innerText = `${m}:${s<10?'0'+s:s}`;
            document.getElementById('restore-popup').style.display = 'block';
        }
    };

    function showYTPopup() { document.getElementById('yt-popup').style.display = 'block'; document.getElementById('yt-input').focus(); }
    
    function loadYTFromInput() {
        const url = document.getElementById('yt-input').value;
        const id = extractVideoID(url);
        if(id) {
            switchMode('youtube');
            ytPlayer.loadVideoById(id);
            if(conn && conn.open) conn.send({type:'yt_load', id: id});
            document.getElementById('yt-popup').style.display = 'none';
            document.getElementById('yt-input').value = '';
        } else {
            alert("Invalid YouTube URL");
        }
    }

    function extractVideoID(url) {
        var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        var match = url.match(regExp);
        return (match && match[2].length == 11) ? match[2] : null;
    }

    function fullExit() { localStorage.removeItem('activeRoom'); localStorage.removeItem('activeRole'); location.reload(); }
    
    async function toggleHardMute() {
        if (!currentCall || !currentCall.open) return sysMsg("Call not active");
        if(localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null; sysMsg("Mic Muted"); setMuteUI(false);
        } else {
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({audio: true});
                localStream = newStream;
                const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'audio');
                if (sender) sender.replaceTrack(newStream.getAudioTracks()[0]);
                sysMsg("Mic ON"); setMuteUI(true);
            } catch(e) { alert("Mic Access Denied."); }
        }
    }

    function setMuteUI(isOn) {
        const btn = document.getElementById('muteBtn');
        btn.className = isOn ? 'c-btn mic-on' : 'c-btn mic-off';
        btn.innerHTML = isOn ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
    }

    function startHeartbeat() {
        clearInterval(heartbeatInterval); clearTimeout(heartbeatTimer);
        heartbeatInterval = setInterval(() => { if(conn && conn.open) conn.send({type:'heartbeat'}); }, 4000);
        resetHeartbeat();
    }
    function resetHeartbeat() {
        clearTimeout(heartbeatTimer);
        heartbeatTimer = setTimeout(() => { document.getElementById('status').innerText = "Weak Signal..."; document.getElementById('status').className = "status-pill"; }, 20000);
        const el = document.getElementById('status');
        if(conn && conn.open && el.innerText !== "Connected") { el.innerText = "Connected"; el.className = "status-pill green"; document.getElementById('user-count').innerText = "2 / 2"; }
    }
    function setStatus(active) {
        const el = document.getElementById('status');
        if(active) { el.innerText = "Connected"; el.className = "status-pill green"; document.getElementById('user-count').innerText = "2 / 2"; startHeartbeat(); }
        else { el.innerText = "Disconnected"; el.className = "status-pill"; document.getElementById('user-count').innerText = "1 / 2"; clearInterval(heartbeatInterval); }
    }

    setInterval(() => { if(!vid.paused) localStorage.setItem('lastTime', vid.currentTime); }, 5000);
    function restoreTime() { vid.currentTime = parseFloat(localStorage.getItem('lastTime')); closePopup(); }
    function closePopup() { document.getElementById('restore-popup').style.display = 'none'; }
    function send() { const i = document.getElementById('msgInput'); const t = i.value.trim(); if(!t) return; if(conn && conn.open) conn.send({type:'chat', msg:t}); addMsg('me', t); i.value = ''; }
    function addMsg(cls, txt) { const c = document.getElementById('chat'); const d = document.createElement('div'); d.className = `msg ${cls}`; d.innerText = txt; c.appendChild(d); c.scrollTop = c.scrollHeight; }
    function playAudio(s) { document.getElementById('remoteAudio').srcObject = s; }
    function sysMsg(txt) { addMsg('sys', txt); }

</script>
</body>
</html>